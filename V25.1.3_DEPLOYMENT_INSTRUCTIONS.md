# üöÄ V25.1.3 DEPLOYMENT INSTRUCTIONS

## ‚ùå ROOT CAUSE IDENTIFIED

**Problem**: Edge Function yang sedang running di production mengembalikan:
```json
{
  "message": "Hello undefined!"
}
```

**Expected**: Edge Function seharusnya mengembalikan data pembayaran lengkap:
```json
{
  "success": true,
  "requestId": "REQ-xxx",
  "paymentMethod": "va",
  "data": {
    "account_number": "xxx",
    "bank_code": "BCA",
    "expected_amount": 79000,
    ...
  }
}
```

**Conclusion**: Edge Function `xendit-payment-1` yang di-deploy ke Supabase adalah **VERSI LAMA/TEST**, bukan kode V25 yang ada di repository!

---

## ‚úÖ SOLUTION: Re-Deploy Edge Function

### Option 1: Using Supabase CLI (RECOMMENDED)

```bash
# 1. Install Supabase CLI (jika belum)
npm install -g supabase

# 2. Login ke Supabase
supabase login

# Token: sbp_046e6ce52a5240498c93d6743697e8b5b7279b14

# 3. Link project
cd /path/to/webapp
supabase link --project-ref cdwzivzaxvdossmwbwkl

# 4. Deploy Edge Function
supabase functions deploy xendit-payment-1

# 5. Set Xendit Secret (jika belum)
supabase secrets set XENDIT_SECRET_KEY=xnd_development_fdh9Gj3Ivjb4K90JQ7OVcHRFa0X8x6sFbAASVW01eUyjysMiNSXjPCNENNdU7gy

# 6. Verify deployment
curl -X POST https://cdwzivzaxvdossmwbwkl.supabase.co/functions/v1/xendit-payment-1 \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNkd3ppdnpheHZkb3NzbXdid2tsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMjA4NjAsImV4cCI6MjA4MDY5Njg2MH0.u4yPiDxrB9r1u-9kqA3Zno5Eyum-rHFv8C6AmP3cJ2Y" \
  -H "Content-Type: application/json" \
  -d '{
    "planId": "starter",
    "email": "test@example.com",
    "phoneNumber": "081234567890",
    "customerName": "Test User",
    "paymentMethod": "va",
    "channelCode": "BCA_VIRTUAL_ACCOUNT"
  }'
```

### Option 2: Using Supabase Dashboard (MANUAL)

1. **Login ke Supabase Dashboard**: https://app.supabase.com
2. **Navigate**: Project `cdwzivzaxvdossmwbwkl` ‚Üí Edge Functions
3. **Select Function**: `xendit-payment-1`
4. **Replace Code**: Copy-paste dari `supabase/functions/xendit-payment-1/index.ts`
5. **Deploy**: Click "Deploy" button
6. **Verify Secrets**: Ensure `XENDIT_SECRET_KEY` is set
7. **Test**: Run test payload from dashboard

### Option 3: Using GitHub Actions (AUTOMATED)

Create `.github/workflows/deploy-supabase.yml`:

```yaml
name: Deploy Supabase Edge Functions

on:
  push:
    branches: [main]
    paths:
      - 'supabase/functions/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        
      - name: Deploy to Supabase
        run: |
          supabase link --project-ref cdwzivzaxvdossmwbwkl
          supabase functions deploy xendit-payment-1
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
```

---

## üß™ VERIFICATION STEPS

After deploying, run these verification tests:

### Test 1: Virtual Account
```bash
cd /path/to/webapp
node test-proxy-v25.1.3.js
```

**Expected Output**:
```
‚úÖ SUCCESS: Edge Function returned payment data
üì¶ Payment Data Structure:
   - Has account_number: true
   - Has bank_code: true
   - Account Number: 9886612345678901
   - Bank Code: BCA
```

### Test 2: E2E Test via Next.js
```bash
# Start dev server
npm run dev

# Open browser: http://localhost:3000/checkout?plan=starter
# Fill form and select Virtual Account
# Click "Bayar Sekarang"
# Should redirect to /payment/pending with VA number
```

---

## üìù FIXES APPLIED IN V25.1.3

### 1. Next.js Proxy Enhanced Logging
- Added debug logging untuk trace data extraction
- Log extracted `vaNumber`, `checkoutUrl` sebelum dikirim ke frontend
- Membantu debugging jika Edge Function mengembalikan data yang salah

### 2. Code Review Completed
- ‚úÖ Edge Function code (index.ts): CORRECT
- ‚úÖ Next.js Proxy (route.ts): CORRECT with enhanced logging
- ‚úÖ Frontend (page.tsx): CORRECT
- ‚ùå **Deployed Edge Function**: WRONG VERSION (needs re-deployment)

---

## üîç DEBUGGING CHECKLIST

If payment still fails after re-deployment:

1. **Check Edge Function Logs** (Supabase Dashboard):
   ```
   Should see:
   - "üìù Incoming Request: {...}"
   - "üöÄ Xendit VA Request: {...}"
   - "üì• Xendit VA Response: {...}"
   - "‚úÖ Success Response: {...}"
   ```

2. **Check Next.js Proxy Logs** (Vercel/Local):
   ```
   Should see:
   - "üîµ V25 PROXY REQUEST STARTED"
   - "üì• Edge Function Response: {...}"
   - "üîç V25.1.3 DATA EXTRACTION DEBUG: {...}"
   - "üîç V25.1.3 EXTRACTED VALUES: {...}"
   - "‚úÖ V25 PROXY: SUCCESS"
   ```

3. **Check Frontend Logs** (Browser Console):
   ```
   Should see:
   - "‚úÖ Payment created successfully"
   - "üì¶ Payment data: {...}"
   - "‚úÖ VA Number received: 9886xxx" OR
   - "üîÄ Redirecting to E-Wallet checkout: https://xxx"
   ```

---

## üìä SUMMARY

- **Issue**: Edge Function deployed adalah versi lama (returns `{ message: "Hello undefined!" }`)
- **Fix**: Re-deploy Edge Function `xendit-payment-1` menggunakan code dari `supabase/functions/xendit-payment-1/index.ts`
- **Status**: Next.js Proxy sudah CORRECT dengan enhanced logging
- **Next Step**: Deploy Edge Function ‚Üí Test ‚Üí Verify payment flow works end-to-end

---

## üöÄ QUICK DEPLOY COMMAND

```bash
# One-liner untuk deploy Edge Function
cd /path/to/webapp && \
supabase login && \
supabase link --project-ref cdwzivzaxvdossmwbwkl && \
supabase functions deploy xendit-payment-1 && \
echo "‚úÖ Edge Function deployed successfully!"
```

---

**Last Updated**: 2025-12-11
**Version**: V25.1.3
**Author**: AI Assistant
